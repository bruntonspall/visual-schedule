// Generated by CoffeeScript 1.3.3
(function() {
  var handleScheduleUpdate, log;

  log = function(msg) {
    console.log(msg);
    $.post("/log?msg=" + msg, {});
    $('.msgs').prepend("<p>" + msg + "</p>");
    $('.msgs').slideDown(333);
    return setTimeout((function() {
      return $('.msgs').slideUp(666);
    }), 2000);
  };

  handleScheduleUpdate = function(event, ui) {
    var domp, schedule_key;
    log($(this));
    domp = $(".schedule .picture").filter(function() {
      return $(this).data('key') === ui.helper.data('key');
    });
    domp.css({
      top: ui.position.top,
      left: ui.position.left
    });
    schedule_key = $('body').data('schedule');
    return $.post("/schedule/" + schedule_key, {
      "key": ui.helper.data('key'),
      "type": ui.helper.data('type'),
      "left": ui.position.left,
      "top": ui.position.top
    }, function(data) {
      var newpic;
      if ($(ui.helper).data('type') === 'picture') {
        newpic = $(ui.helper).clone();
        newpic.attr('data-type', 'placement');
        newpic.attr('data-key', data);
        newpic.draggable({
          stop: handleScheduleUpdate,
          helper: "clone",
          opacity: 0.40
        });
        return $('.schedule').append(newpic);
      }
    });
  };

  $(function() {
    var schedule_key;
    $('#msgs').hide();
    $('.picture').draggable({
      helper: "clone",
      opacity: 0.40
    });
    $(".schedule").droppable({
      accept: ".picture",
      drop: handleScheduleUpdate
    });
    $(".picturebar").droppable({
      accept: ".picture",
      drop: function(event, ui) {
        var original, placementkey;
        placementkey = ui.helper.data('key');
        original = $(".schedule .picture").filter(function() {
          return $(this).data('key') === ui.helper.data('key');
        });
        return $.ajax({
          type: 'DELETE',
          url: "/schedule/" + schedule_key + "/" + placementkey,
          success: function(data) {
            return original.remove();
          }
        });
      }
    });
    schedule_key = $('body').data('schedule');
    log("Schedule is " + schedule_key);
    return $.getJSON("/schedule/" + schedule_key, function(data) {
      var domp, p, _i, _len, _ref, _results;
      _ref = data.pictures;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        domp = $(".schedule .picture").filter(function() {
          return $(this).data('key') === p.id;
        });
        _results.push(domp.css({
          top: p.top,
          left: p.left
        }));
      }
      return _results;
    });
  });

}).call(this);
